// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TaskStatus {
  PENDING
  RUNNING
  NEEDS_HELP
  NEEDS_REVIEW
  COMPLETED
  CANCELLED
  FAILED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum Role {
  USER
  ASSISTANT
}

enum TaskType {
  IMMEDIATE
  SCHEDULED
}

// Matches DB enum public."ExecutionSurface"
enum ExecutionSurface {
  TEXT_ONLY
  DESKTOP
}

model Task {
  id            String        @id @default(uuid())
  description   String
  // v2.2.16: AI-generated short title for task list display (max 100 chars)
  title         String?       @db.VarChar(100)
  type          TaskType      @default(IMMEDIATE)
  status        TaskStatus    @default(PENDING)
  priority      TaskPriority  @default(MEDIUM)
  control       Role          @default(ASSISTANT)
  // v2.3.0 M4: Execution surface contract
  // requiresDesktop: non-null default false; executionSurface: nullable override
  requiresDesktop Boolean      @default(false)
  executionSurface ExecutionSurface?
  createdAt     DateTime      @default(now())
  createdBy     Role          @default(USER)
  scheduledFor  DateTime?
  updatedAt     DateTime      @updatedAt
  executedAt    DateTime?
  completedAt   DateTime?
  queuedAt      DateTime?
  error         String?
  result        Json?
  // Example:
  // { "provider": "anthropic", "name": "claude-opus-4-20250514", "title": "Claude Opus 4" }
  model         Json
  messages      Message[]
  summaries     Summary[]
  files         File[]
  // v2.0.28: Added for optimistic locking to prevent race conditions
  // Incremented on each update to detect concurrent modifications
  version       Int           @default(0)

  // v2.1.0 Phase 6.0: Artifact and action log relations
  artifacts     TaskArtifact[]
  actionLogs    TaskActionLog[]
}

model Summary {
  id             String     @id @default(uuid())
  content        String
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  messages       Message[]  // One-to-many relationship: one Summary has many Messages

  task      Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    String
  
  // Self-referential relationship
  parentSummary  Summary?   @relation("SummaryHierarchy", fields: [parentId], references: [id])
  parentId       String?
  childSummaries Summary[]  @relation("SummaryHierarchy")
}

model Message {
  id        String      @id @default(uuid())
  // Content field follows Anthropic's content blocks structure
  // Example: 
  // [
  //   {"type": "text", "text": "Hello world"},
  //   {"type": "image", "source": {"type": "base64", "media_type": "image/jpeg", "data": "..."}}
  // ]
  content   Json
  role      Role @default(ASSISTANT)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  task      Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    String
  summary   Summary?    @relation(fields: [summaryId], references: [id])
  summaryId String?     // Optional foreign key to Summary
}

model File {
  id            String      @id @default(uuid())
  name          String
  type          String      // MIME type
  size          Int         // Size in bytes
  data          String      // Base64 encoded file data
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  task          Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId        String
}

// v2.1.0 Phase 6.0: Artifact types for S3/MinIO storage
enum ArtifactType {
  RECORDING     // VNC session recordings (webm)
  SCREENSHOT    // Desktop screenshots (png)
  ACTION_LOG    // Agent action logs (jsonl)
  OUTPUT        // Task output files
  TEMP          // Temporary files (auto-expire)
}

// v2.1.0 Phase 6.0: Task artifacts stored in MinIO
// References objects in bytebot-artifacts bucket on store cluster
model TaskArtifact {
  id              String        @id @default(uuid())
  taskId          String
  tenantId        String        @db.VarChar(100)

  // S3/MinIO Reference
  bucketName      String        @default("bytebot-artifacts") @db.VarChar(255)
  objectKey       String        @db.Text  // e.g., "tenant-1/task-abc/recordings/session.webm"

  // Artifact Metadata
  artifactType    ArtifactType
  fileName        String        @db.VarChar(1024)
  contentType     String        @db.VarChar(255)  // MIME type
  sizeBytes       BigInt
  checksum        String?       @db.VarChar(64)   // SHA256 hash

  // Lifecycle
  retentionDays   Int           @default(30)
  expiresAt       DateTime?
  deletedAt       DateTime?     // Soft delete

  // Flexible metadata (JSONB)
  // Examples: { "duration": 3600, "resolution": "1920x1080" }
  metadata        Json?
  tags            String[]      @default([])

  // Timestamps
  createdAt       DateTime      @default(now())
  accessedAt      DateTime?

  // Relations
  task            Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Indexes for common queries
  @@index([taskId])
  @@index([tenantId])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([deletedAt])
  @@index([taskId, artifactType])
  @@index([tenantId, createdAt])

  @@map("task_artifacts")
}

// v2.1.0 Phase 6.0: Agent action log entry
// Stores structured logs of all agent actions for audit and retraining
model TaskActionLog {
  id              String        @id @default(uuid())
  taskId          String

  // Action Details
  actionType      String        @db.VarChar(100)  // click, type, scroll, screenshot, etc.
  actionStatus    String        @default("success") @db.VarChar(50)  // success, failed, skipped

  // Timing
  timestamp       DateTime      @default(now())
  durationMs      Int?          // Action duration in milliseconds

  // Action Context
  // Element interacted with (button, input, link, etc.)
  elementDescription  String?   @db.Text
  // Coordinates if applicable
  coordinates     Json?         // { "x": 450, "y": 320 }
  // Keyboard input (masked for passwords)
  maskedInput     String?       @db.Text

  // Screenshot reference (links to TaskArtifact)
  screenshotKey   String?       @db.VarChar(500)

  // LLM Context
  // Why the agent took this action
  llmReasoning    String?       @db.Text
  llmModel        String?       @db.VarChar(100)
  llmTokenCount   Int?

  // Flexible action data (JSONB)
  // Examples: { "selector": "button.submit", "value": "***" }
  actionData      Json?

  // Error info if failed
  errorMessage    String?       @db.Text

  // Relations
  task            Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Indexes for common queries
  @@index([taskId])
  @@index([timestamp])
  @@index([actionType])
  @@index([actionStatus])
  @@index([taskId, timestamp])

  @@map("task_action_logs")
}
